#include <complex.h>
#include <errno.h>
#include <fenv.h>
#include <float.h>
#include <limits.h>
#include <locale.h>
#include <math.h>
#include <setjmp.h>
#include <signal.h>
#include <stdatomic.h>
#include <stddef.h>
#include <stdbool.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <time.h>

// we need to represent the C struct in Go
// so we sort all fields by offset and then 
// print the type and name of each field
// for structures with implementation-defined
// order.
typedef struct {
    const char *source;
    size_t offset;
} field_t;

int compare_fields(const void *a, const void *b) {
    const field_t *fa = a;
    const field_t *fb = b;
    return fa->offset - fb->offset;
}

void structure(const char *name, field_t fields[]) {
    int length = 0;
    for (int i = 0; 1; i++) {   
        length = i;
        if (*fields[i].source == 0) {
            break;
        }
     }
    qsort(fields, length, sizeof(field_t), compare_fields);
    printf("type %s struct {\n", name);
    for (int i = 0; i < length; i++) {
        printf("\t%s\n", fields[i].source);
    }
    printf("}\n\n");
}

char* goType(size_t bytes, bool sign) {
    if (sign) {
        switch (bytes*CHAR_BIT) {
            case 8: return "int8";
            case 16: return "int16";
            case 32: return "int32";
            case 64: return "int64";
        }
        char* buf = calloc(100, sizeof(char));
        sprintf(buf, "[%d]byte", (int)bytes);
        return buf;
    }
    switch (bytes*CHAR_BIT) {
        case 8: return "uint8";
        case 16: return "uint16";
        case 32: return "uint32";
        case 64: return "uint64";
    }
    char* buf = calloc(100, sizeof(char));
    sprintf(buf, "[%d]byte", (int)bytes);
    return buf;
}

int main(int argc, char *argv[]) {
    fesetenv(FE_DFL_ENV);

    printf("// Code generated by gen/gen.c; DO NOT EDIT.\n\n");
    printf("package std\n\n");

    printf("type (\n");
    printf("\tc_char                %s\n", goType(sizeof(char), CHAR_MIN < 0));
    printf("\tc_signed_char         %s\n", goType(sizeof(signed char), true));
    printf("\tc_unsigned_char       %s\n", goType(sizeof(unsigned char), false));
    printf("\tc_short               %s\n", goType(sizeof(short), SHRT_MIN < 0));
    printf("\tc_unsigned_short      %s\n", goType(sizeof(unsigned short), false));
    printf("\tc_int                 %s\n", goType(sizeof(int), INT_MIN < 0));
    printf("\tc_unsigned_int        %s\n", goType(sizeof(unsigned int), false));
    printf("\tc_long                %s\n", goType(sizeof(long), LONG_MIN < 0));
    printf("\tc_unsigned_long       %s\n", goType(sizeof(unsigned long), false));
    printf("\tc_longlong            %s\n", goType(sizeof(long long), LLONG_MIN < 0));
    printf("\tc_unsigned_longlong   %s\n", goType(sizeof(unsigned long long), false));
    printf("\tc_float               float%d\n", (unsigned)sizeof(float)*CHAR_BIT);
    printf("\tc_double              float%d\n", (unsigned)sizeof(double)*CHAR_BIT);

    printf("\tc_int8_t              %s\n", goType(sizeof(int8_t), true));
    printf("\tc_int16_t             %s\n", goType(sizeof(int16_t), true));
    printf("\tc_int32_t             %s\n", goType(sizeof(int32_t), true));
    printf("\tc_int64_t             %s\n", goType(sizeof(int64_t), true));
    printf("\tc_uint8_t             %s\n", goType(sizeof(uint8_t), false));
    printf("\tc_uint16_t            %s\n", goType(sizeof(uint16_t), false));
    printf("\tc_uint32_t            %s\n", goType(sizeof(uint32_t), false));
    printf("\tc_uint64_t            %s\n", goType(sizeof(uint64_t), false));
    printf("\tc_uintptr_t           %s\n", goType(sizeof(uintptr_t), false));

    printf("\tc_size_t               %s\n", goType(sizeof(size_t), false));
    printf("\tc_time_t               %s\n", goType(sizeof(time_t), true));
    printf("\tc_clock_t              %s\n", goType(sizeof(clock_t), true));

    printf("\tc_bool                 %s\n", goType(sizeof(_Bool), false));

    printf(")\n");
}